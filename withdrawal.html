<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Withdraw Earnings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      background: linear-gradient(145deg, #0470fd, #032a79, #0470fd, #01256e);
      color: white;
    }

    .btn-gold {
      background-color: #ffd700;
      color: #000;
      border: none;
    }

    .btn-gold:hover {
      background-color: #e6c200;
    }

    .receipt-box {
      background: linear-gradient(135deg, #032a79, #0470fd, #01256e);
      color: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 15px rgba(255,255,255,0.3);
      margin-top: 20px;
    }

    .receipt-box span {
      font-weight: bold;
    }
  </style>
</head>
<body class="container py-5">
  <h2 class="text-center fw-bolder" style="color: gold;">Withdraw Earnings</h2>

  <form id="withdrawalForm" class="mb-4 mt-4 bg-white text-dark p-4 rounded">
    <div class="mb-3">
      <label class="form-label">Bank Name</label>
      <select class="form-select" name="bank" required>
        <option value="">-- Select Bank --</option>
        <option value="Kuda">Kuda</option>
        <option value="Opay">Opay</option>
        <option value="PalmPay">PalmPay</option>
        <option value="Moniepoint">Moniepoint</option>
        <option value="VBank">VBank</option>
        <option value="Carbon">Carbon</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Account Number</label>
      <input type="text" class="form-control" name="accountNumber" maxlength="10" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Account Name</label>
      <input type="text" class="form-control" name="accountName" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Amount to Withdraw (‚Ç¶)</label>
      <input type="number" class="form-control" name="amount" min="100" required>
    </div>

    <button type="submit" class="btn btn-gold w-100 fw-bold">Submit Withdrawal</button>
  </form>

  <!-- RECEIPT -->
  <div id="receiptContainer" class="receipt-box d-none text-white">
    <h3 class="text-center mb-4" style="color: gold;">üí≥ Withdrawal Receipt</h3>
    <div class="mb-2"><strong>Bank:</strong> <span id="r-bank"></span></div>
    <div class="mb-2"><strong>Account Number:</strong> <span id="r-acctnum"></span></div>
    <div class="mb-2"><strong>Account Name:</strong> <span id="r-acctname"></span></div>
    <div class="mb-2"><strong>Amount:</strong> ‚Ç¶<span id="r-amount"></span></div>
    <div class="mb-2"><strong>Date:</strong> <span id="r-date"></span></div>
    <div class="mb-3"><strong>Status:</strong> <span style="color: gold;">‚è≥ Pending</span></div>

    <button id="downloadBtn" class="btn btn-gold mt-3 fw-bold w-100">üì• Download Receipt</button>
  </div>

  <script>
    let userBalance = 0;

    // Fetch user balance on page load
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/user/balance', { credentials: 'include' });
        const data = await res.json();
        if (res.ok) {
          userBalance = data.balance || 0;
        } else {
          alert("Failed to fetch balance");
        }
      } catch (err) {
        console.error("Error fetching balance:", err);
      }
    });

    // Withdrawal form submit
    document.getElementById('withdrawalForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const amount = parseFloat(formData.get('amount'));

      if (amount > userBalance) {
        alert(`Insufficient balance. You only have ‚Ç¶${userBalance.toFixed(2)}.`);
        return;
      }

      const payload = {
        bank: formData.get('bank'),
        accountNumber: formData.get('accountNumber'),
        accountName: formData.get('accountName'),
        amount
      };

      try {
        const res = await fetch('/withdraw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (res.ok) {
          // Fill receipt
          document.getElementById('r-bank').innerText = payload.bank;
          document.getElementById('r-acctnum').innerText = payload.accountNumber;
          document.getElementById('r-acctname').innerText = payload.accountName;
          document.getElementById('r-amount').innerText = amount.toFixed(2);
          document.getElementById('r-date').innerText = new Date().toLocaleString();
          document.getElementById('receiptContainer').classList.remove('d-none');
          form.reset();
        } else {
          alert(data.message || 'Withdrawal failed');
        }
      } catch (error) {
        alert('Error sending withdrawal request');
        console.error(error);
      }
    });

    // Download receipt
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const receipt = document.getElementById('receiptContainer');
      html2canvas(receipt).then(canvas => {
        const link = document.createElement('a');
        link.download = `withdrawal_receipt_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    });


    window.addEventListener('DOMContentLoaded', async () => {
  try {
    // Check withdrawal status
    const statusRes = await fetch('/admin/withdrawal-status', { credentials: 'include' });
    const status = await statusRes.json();
    if (!status.enabled) {
      alert("Today is not Withdrawal day..");
      document.getElementById('withdrawalForm').style.display = 'none';
      return;
    }

    // Continue to fetch user balance
    const res = await fetch('/user/balance', { credentials: 'include' });
    const data = await res.json();
    if (res.ok) {
      userBalance = data.balance || 0;
    } else {
      alert("Failed to fetch balance");
    }
  } catch (err) {
    console.error("Error fetching config:", err);
  }
});

  </script>
</body>
</html>
